# project_3128 — ROADMAP

## 0. Текущее состояние (зафиксировано)

- Репозиторий: https://github.com/FuzzyDi/project_3128
- Стек:
  - Node.js + Express (api/)
  - PostgreSQL (database/init.sql)
  - Docker Compose (api + db + frontend + telegram-bot + nginx)
  - Telegram-бот (telegram-bot/)
  - Frontend-слой и nginx-конфиг

### API и функциональность

- Реализован базовый API для мерчанта:
  - `GET /api/v1/merchant` — данные о мерчанте по `X-API-Key`.
  - `GET /api/v1/merchant/dashboard` —:
    - общее количество клиентов
    - суммарно начисленные/списанные баллы
    - список последних транзакций (purchase/points_redemption).
- Для демо-мерчанта:
  - есть набор тестовых транзакций в БД
  - начисление и списание баллов уже выполнялись и отражаются в дашборде.

### Структура backend

- `api/server.js` — точка входа Express-приложения.
- `api/db.js` — подключение к PostgreSQL.
- `api/routes/` — роуты API:
  - `merchantRoutes.js`
  - `merchantSettingsRoutes.js`
  - `loyaltyRoutes.js`
  - `integrationRoutes.js`
  - `botRoutes.js`
- `api/services/` — бизнес-логика (например, `merchantService.js`).
- БД инициализируется через `database/init.sql` (структура таблиц: мерчанты, клиенты, транзакции, связи).


---

## 1. Ближайшие задачи (MVP+ / hardening)

### 1.1. Привести API v1 к стабильному контракту

- [ ] Описать API v1 в отдельном файле `docs/api_v1.md`:
  - эндпоинты, методы, параметры, ответы, коды ошибок.
- [ ] Добавить обработку ошибок и единый формат ответа об ошибке (например, `{ error: { code, message } }`).
- [ ] Добавить базовую валидацию входных данных (например, `express-validator` или собственные middleware).

### 1.2. Настройки правил лояльности мерчанта

- [ ] В `merchantSettings` хранить:
  - `earnRatePer1000` (сколько баллов за 1000 единиц валюты)
  - `redeemMaxPercent`
  - `minReceiptAmountForEarn`
  - `redeemMinPoints`
  - `redeemStep`
  - `maxPointsPerReceipt`
  - `maxPointsPerDay`
- [ ] Реализовать эндпоинты:
  - посмотреть настройки,
  - изменить настройки.
- [ ] Подключить эти настройки к логике начисления/списания.

### 1.3. Телеграм-бот: базовый функционал

- [ ] Эндпоинт webhook для бота в api (botRoutes).
- [ ] Команды:
  - `/start` — привязка клиента к мерчанту.
  - `/balance` — показать баланс и последние транзакции.
- [ ] Простая авторизация по телефону/коду или по ссылке-ключу от кассы.

### 1.4. Простой POS-сценарий (frontend/public)

- [ ] Статическая страница или мини-POS-симулятор:
  - ввод суммы,
  - показ начисленных/списанных баллов,
  - вызовы API.
- [ ] Связать это с демо-мерчантом.

---

## 2. Среднесрочные задачи

### 2.1. Отчеты и аналитика

- [ ] Добавить слой отчетов:
  - отчеты по мерчанту за период,
  - топ-клиенты по начислениям/списаниям,
  - нагрузка по дням/часам.
- [ ] API для отчетов (например, `/api/v1/merchant/reports/...`).
- [ ] Простейший UI для просмотра (или экспорт в CSV/JSON).

### 2.2. Улучшение модели данных

- [ ] Чётко задокументировать структуру БД в `docs/ARCHITECTURE.md` (таблицы, связи).
- [ ] Подумать о расширении:
  - поддержка нескольких мерчантов (multi-merchant),
  - разделение клиентов по мерчантам,
  - возможность иметь несколько программ лояльности на одного мерчанта.

### 2.3. Логирование и мониторинг

- [ ] Встроить нормальный логгер (уровни: info/warn/error, корреляция по request-id).
- [ ] Логировать ключевые события:
  - создание клиента,
  - начисление/списание,
  - критические ошибки.
- [ ] Минимальные метрики (через простые endpoints или интеграцию с Prometheus/Grafana в будущем).

---

## 3. Долгосрочные планы

### 3.1. Многопользовательский SaaS-режим

- [ ] Регистрация новых мерчантов через API/UI.
- [ ] Управление пользователями (админы мерчанта, кассиры и т.п.).
- [ ] Отдельные API-ключи для разных каналов (POS, сайт, бот).

### 3.2. Гибкий конструктор правил лояльности

- [ ] Несколько типов правил:
  - за сумму чека,
  - за количество покупок,
  - за регистрацию/приглашение друга (реферальная схема),
  - кампании с ограниченным сроком действия.
- [ ] Хранение правил в таблицах с динамическими условиями.
- [ ] Интерпретатор/движок правил.

### 3.3. Боевой деплой

- [ ] Продумать целевой стенд (VPS, Kubernetes или managed сервис).
- [ ] CI/CD pipeline для деплоя из GitHub.
- [ ] Резервное копирование БД, миграции, обновления.

---

## 4. Принцип работы с roadmap

- Любое важное решение, принятое в чатах, переносить сюда короткой записью.
- Перед крупными изменениями — фиксировать:
  - что делаем,
  - зачем,
  - в каких файлах.
- Поддерживать документ в репозитории как единую точку правды.
