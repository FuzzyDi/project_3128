
---

## `docs/ROADMAP.md`

Создай папку `docs` и файл `docs/ROADMAP.md` с таким содержимым:

```markdown
# project_3128 — Roadmap

Этот документ фиксирует текущее состояние проекта и планы развития.

---

## 1. Что уже сделано (фиксируем текущий результат)

### Архитектура и инфраструктура

- Настроен монорепозиторий с компонентами:
  - `api/` — backend (Node.js / Express + PostgreSQL).
  - `frontend/` — простой фронтенд (POS-демо и статика).
  - `telegram-bot/` — Telegram-бот.
  - `nginx/` — конфиг реверс-прокси.
  - `database/init.sql` — схема БД и демо-данные.
  - `docker-compose.yml` — единая оркестрация всех сервисов.

- Поднятие проекта одной командой:
  - `docker-compose up -d --build`.

### Backend API

- Реализован базовый контур для мерчанта:
  - `GET /api/v1/merchant`
  - `GET /api/v1/merchant/dashboard`
- В модели мерчанта предусмотрены поля для настройки программы лояльности:
  - `earnRatePer1000`
  - `redeemMaxPercent`
  - `minReceiptAmountForEarn`
  - `redeemMinPoints`
  - `redeemStep`
  - `maxPointsPerReceipt`
  - `maxPointsPerDay`
- Есть заготовки маршрутов:
  - `loyaltyRoutes.js` — операции лояльности (покупки/списания).
  - `integrationRoutes.js` — интеграции (POS, внешние системы).
  - `merchantSettingsRoutes.js` — настройки мерчанта.
  - `botRoutes.js` — интеграция с Telegram-ботом.

### База данных

- `init.sql` создаёт структуру таблиц:
  - мерчант, клиенты, транзакции, баланс.
- Создаётся демо-мерчант с API-ключом `sbg_demo_mc4c48c`.
- В БД есть тестовый клиент `DEMO_1` с историей:
  - покупки с начислением баллов;
  - операции списания баллов;
  - корректно считаются `totalEarned` и `totalSpent`.

### Дэшборд

- `GET /api/v1/merchant/dashboard` возвращает:
  - информацию о мерчанте;
  - `customersCount`;
  - `totalEarned` / `totalSpent`;
  - список транзакций с:
    - суммой чека,
    - начисленными и списанными баллами,
    - типом операции (`purchase` / `points_redemption`),
    - датой/временем.

---

## 2. В работе / ближайшие задачи

### 2.1. Настройки программы лояльности

**Цель:** дать мерчанту управляемые параметры программы.

Задачи:

- Реализовать маршруты:
  - `GET /api/v1/merchant/settings`
  - `PUT /api/v1/merchant/settings`
- Связать поля:
  - `earnRatePer1000`
  - `redeemMaxPercent`
  - `minReceiptAmountForEarn`
  - `redeemMinPoints`
  - `redeemStep`
  - `maxPointsPerReceipt`
  - `maxPointsPerDay`
- Добавить валидацию значений (границы, типы, обязательные поля).

### 2.2. Применение настроек в бизнес-логике

**Цель:** чтобы начисление/списание баллов происходило по правилам мерчанта.

Задачи:

- Начисление:
  - перевести сумму чека в баллы согласно `earnRatePer1000`;
  - не начислять, если чек < `minReceiptAmountForEarn`;
  - ограничить `maxPointsPerReceipt` и `maxPointsPerDay`.
- Списание:
  - проверка текущего баланса клиента;
  - ограничение списания по `redeemMaxPercent` от суммы чека;
  - применение `redeemMinPoints` и `redeemStep`.
- Единая схема ошибок для POS/бота:
  - недостаточно баллов,
  - превышен лимит за чек/день,
  - чек ниже минимальной суммы для начисления,
  - и т.п.

---

## 3. Следующие шаги (среднесрочный план)

### 3.1. POS-интеграция

**Цель:** боевой сценарий на кассе (Set Retail 10 и др.).

Задачи:

- Стабилизировать API для кассы:
  - `POST /api/v1/loyalty/calc`
    - вход: данные чека (сумма, позиции, внешний ID, идентификатор клиента);
    - выход: сколько начислить, сколько можно списать, итоговые суммы.
  - `POST /api/v1/loyalty/commit`
    - фиксация операции (покупка/списание).
- Использовать `frontend/public/pos.html` как демо-интеграцию:
  - показать типовой сценарий: идентификация клиента → расчёт → проведение чека.
- Определить правила округления:
  - тип хранения баллов (int/decimal),
  - способ округления при расчёте.

### 3.2. Telegram-бот

**Цель:** удобная точка входа для клиента.

Задачи:

- Функционал бота:
  - проверка баланса,
  - просмотр последних операций,
  - привязка к магазину/мерчанту,
  - уведомления о начислениях/списаниях.
- Связать бота с API:
  - бот должен использовать существующий backend (никакой “отдельной” логики баллов).

### 3.3. Расширение аналитики

**Цель:** полезный дэшборд для владельца магазина.

Задачи:

- Расширить `dashboard`:
  - суммарный оборот,
  - средний чек,
  - количество уникальных активных клиентов,
  - базовые метрики удержания.
- Подготовить чистый JSON-слой под будущую админ-панель.

---

## 4. Долгосрочные идеи

- Мульти-мерчант (многотенантность).
- Экспорт отчётов (CSV/Excel).
- Интеграция с внешними системами (Set Retail 10, ERP, Friend-Bonus core).
- Управление несколькими программами лояльности (бонусная, кэшбэк, реферальная).

---

## 5. Правила синхронизации (git)

Для фиксации этапов развития:

- После логических изменений:
  - `git add .`
  - `git commit -m "feat: ..." / "fix: ..." / "refactor: ..."`
  - `git push`
- Для крупных вех можно использовать теги:
  - `v0.1.0` — базовый контур мерчанта и дэшборда;
  - `v0.2.0` — настройки программы лояльности и их применение;
  - далее по мере развития.
