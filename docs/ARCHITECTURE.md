# project_3128 — Архитектура

## 1. Общий обзор

Проект `project_3128` — демо-сервис бонусной программы лояльности для ритейла:

- хранит данные о мерчантах, клиентах и транзакциях;
- начисляет и списывает бонусные баллы;
- предоставляет API для:
  - интеграции с кассой/внешними системами;
  - работы Telegram-бота;
  - просмотра дашборда/отчетов.

Компоненты:

- **api/** — backend-сервис (Node.js + Express).
- **database/** — SQL-скрипты инициализации PostgreSQL.
- **frontend/** — фронтенд-сервер и статические страницы/демо-POS.
- **telegram-bot/** — сервис Telegram-бота.
- **nginx/** — конфиг nginx, фронтинг frontend/API.
- **docker-compose.yml** — оркестрация всего стенда.

---

## 2. Сервисы и их ответственность

### 2.1. API-сервис (`api/`)

**Ответственность:**

- REST API для:
  - управления мерчантами и их настройками,
  - начисления/списания/просмотра транзакций,
  - интеграции с внешними системами (каса, боты),
  - предоставление агрегированных данных (дашборд).
- Работа с PostgreSQL через модуль `db.js`.

**Ключевые файлы:**

- `api/server.js` — точка входа:
  - конфигурация Express,
  - подключение middleware,
  - подключение роутов из `api/routes/`.
- `api/db.js` — модуль подключения к БД:
  - создание пула соединений (например, `pg.Pool`),
  - экспорт функции/объекта для выполнения запросов.

**Роуты (`api/routes/`):**

- `merchantRoutes.js`  
  Отвечает за операции с мерчантом:
  - получение информации о мерчанте по `X-API-Key`;
  - возможно, создание/обновление мерчанта (TODO: уточнить по коду).
- `merchantSettingsRoutes.js`  
  Настройки программы лояльности для мерчанта:
  - earnRatePer1000, redeemMaxPercent и т.д.
- `loyaltyRoutes.js`  
  Операции по начислению/списанию баллов, запрос баланса и истории (TODO: дописать конкретные эндпоинты по файлу).
- `integrationRoutes.js`  
  Точки интеграции с внешними системами (например, POS, веб-сайт).
- `botRoutes.js`  
  Webhook и вспомогательные эндпоинты для Telegram-бота.

**Сервисы (`api/services/`):**

- `merchantService.js`  
  Инкапсулирует бизнес-логику по мерчантам:
  - поиск мерчанта по apiKey;
  - сбор данных для dashboard (customersCount, totalEarned, totalSpent, список транзакций).
- TODO: добавить сюда описание других сервисов по мере появления (`loyaltyService`, `customerService`, etc.).

---

## 3. База данных

База — PostgreSQL. Структура описана в:

- `database/init.sql`

> ⚠️ TODO: ниже — обобщённая структура. При необходимости уточнить названия полей и таблиц по фактическому `init.sql`.

**Основные сущности:**

1. **Merchants (мерчанты)**  
   - Идентификатор мерчанта.
   - Код мерчанта (например, `MC4C48C`).
   - Название (например, `Demo Shop`).
   - API-ключ (`apiKey` вида `sbg_demo_...`).
   - Настройки лояльности:
     - `earnRatePer1000`
     - `redeemMaxPercent`
     - `minReceiptAmountForEarn`
     - `redeemMinPoints`
     - `redeemStep`
     - `maxPointsPerReceipt`
     - `maxPointsPerDay`
   - Даты создания/обновления.
   - Статус (например, `active`).

2. **Customers / CustomerMerchant**  
   - Клиенты системы лояльности.
   - Связь клиент ↔ мерчант (один клиент может обслуживаться у разных мерчантов).
   - Контактные данные (телефон и др., если используются).

3. **Transactions (транзакции)**  
   - Типы:
     - `purchase` — покупка с начислением баллов;
     - `points_redemption` — списание баллов.
   - Связь с мерчантом и клиентом.
   - Внешний ID (например, идентификатор чека/операции в POS, `externalId`).
   - Сумма в валюте (`amount`).
   - Начисленные баллы (`pointsEarned`).
   - Списанные баллы (`pointsSpent`).
   - Статус (`completed` и др.).
   - Дата/время.

---

## 4. Потоки данных

### 4.1. Начисление/списание через API

1. Внешняя система (POS, сайт, бот) обращается к API:
   - предоставляет `X-API-Key` мерчанта;
   - передает данные по клиенту и сумме покупки/операции.
2. API:
   - находит мерчанта по apiKey;
   - рассчитывает начисляемые или списываемые баллы по правилам мерчанта;
   - создаёт запись в таблице транзакций;
   - возвращает новое состояние баланса клиента.

### 4.2. Дашборд мерчанта

1. Клиент (frontend или внешний инструмент) запрашивает `GET /api/v1/merchant/dashboard` с заголовком `X-API-Key`.
2. API:
   - находит мерчанта;
   - собирает агрегированные данные:
     - количество уникальных клиентов,
     - сколько всего начислено/списано баллов,
     - последние N транзакций.
3. Возвращает JSON с объектом `dashboard`.

---

## 5. Инфраструктура и деплой

### 5.1. Docker Compose

Файл: `docker-compose.yml`.

Сервисы (примерная структура, уточнить по файлу):

- `api` — Node.js backend.
- `db` — PostgreSQL, тома для хранения данных.
- `frontend` — фронтенд-сервер.
- `telegram-bot` — бот-сервис.
- `nginx` — фронтинг всех HTTP-запросов.

Каждый сервис билдится из соответствующей директории (api/, frontend/, telegram-bot/, nginx/).

### 5.2. Nginx

Файл: `nginx/nginx.conf`.

Типовая схема:

- Принимает HTTP снаружи.
- Проксирует:
  - `/api/` → контейнер `api`
  - статику/фронт → контейнер `frontend`
- Опционально — отдельные location для webhook бота и т.д.

---

## 6. TODO по архитектуре

- [ ] Внести точные схемы таблиц из `database/init.sql` (названия столбцов, индексы, связи).
- [ ] Задокументировать все существующие эндпоинты API (methods, paths, inputs, outputs).
- [ ] Оформить раздел по Telegram-боту:
  - как он ходит в api,
  - какие команды реализованы,
  - как настроен webhook.
- [ ] Добавить раздел “Security”:
  - авторизация по API-ключам,
  - возможные будущие механизмы (JWT и т.п.).
